name: MLOps CI/CD Pipeline

on:
  push:
    branches: [main, master]
  workflow_dispatch:

env:
  PROJECT_ID: adroit-metric-473508-k1
  GKE_CLUSTER: iris-cluster
  GKE_ZONE: us-central1
  DEPLOYMENT_NAME: heart-disease-app
  IMAGE_NAME: heart-disease-app
  ARTIFACT_REGISTRY: us-central1-docker.pkg.dev
  REPOSITORY: heart-disease-repo

jobs:
  setup-build-deploy:
    name: Setup, Build, and Deploy
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        install_components: 'gke-gcloud-auth-plugin'

    - name: Configure Docker
      run: |
        gcloud auth configure-docker ${{ env.ARTIFACT_REGISTRY }}

    - name: Build Docker Image
      run: |
        docker build -f deployment/Dockerfile \
          -t ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
          -t ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest \
          .

    - name: Push Docker Image
      run: |
        docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        docker push ${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest

    - name: Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ env.GKE_CLUSTER }} --zone=${{ env.GKE_ZONE }}

    - name: Deploy Kubernetes Manifests
      env:
        USE_GKE_GCLOUD_AUTH_PLUGIN: True
      run: |
        echo "üì¶ Deploying Kubernetes resources..."
        
        # Check if files exist
        ls -la k8s/
        
        # Apply manifests
        kubectl apply -f k8s/deployment.yaml
        kubectl apply -f k8s/service.yaml
        kubectl apply -f k8s/hpa.yaml
        
        echo "‚úÖ Manifests applied"

    - name: Update Deployment Image
      env:
        USE_GKE_GCLOUD_AUTH_PLUGIN: True
      run: |
        echo "üîÑ Updating deployment image..."
        kubectl set image deployment/${{ env.DEPLOYMENT_NAME }} \
          heart-disease-fastapi=${{ env.ARTIFACT_REGISTRY }}/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
        
        echo "‚è≥ Waiting for rollout..."
        kubectl rollout status deployment/${{ env.DEPLOYMENT_NAME }} --timeout=5m

    - name: Wait for Service
      env:
        USE_GKE_GCLOUD_AUTH_PLUGIN: True
      run: |
        echo "‚è≥ Waiting for LoadBalancer IP (up to 3 minutes)..."
        for i in {1..36}; do
          EXTERNAL_IP=$(kubectl get svc heart-disease-lb -o jsonpath='{.status.loadBalancer.ingress[0].ip}' 2>/dev/null || echo "")
          if [ ! -z "$EXTERNAL_IP" ]; then
            echo "‚úÖ LoadBalancer IP assigned: $EXTERNAL_IP"
            echo "EXTERNAL_IP=$EXTERNAL_IP" >> $GITHUB_ENV
            break
          fi
          echo "Waiting... ($i/36)"
          sleep 5
        done
        
        if [ -z "$EXTERNAL_IP" ]; then
          echo "‚ùå LoadBalancer IP not assigned after 3 minutes"
          kubectl describe svc heart-disease-lb
          exit 1
        fi

    - name: Health Check
      env:
        USE_GKE_GCLOUD_AUTH_PLUGIN: True
      run: |
        echo "üß™ Testing API at http://${{ env.EXTERNAL_IP }}/ready_check"
        
        # Retry health check up to 10 times
        for i in {1..10}; do
          if curl -f -s http://${{ env.EXTERNAL_IP }}/ready_check; then
            echo "‚úÖ Health check passed!"
            exit 0
          fi
          echo "Attempt $i failed, retrying in 5s..."
          sleep 5
        done
        
        echo "‚ùå Health check failed after 10 attempts"
        exit 1

    - name: Deployment Summary
      if: success()
      env:
        USE_GKE_GCLOUD_AUTH_PLUGIN: True
      run: |
        echo "üéâ DEPLOYMENT SUCCESSFUL!"
        echo ""
        echo "üìä Deployment Status:"
        kubectl get deployment ${{ env.DEPLOYMENT_NAME }}
        echo ""
        echo "üîß Pods:"
        kubectl get pods -l app=${{ env.DEPLOYMENT_NAME }}
        echo ""
        echo "üåê Service:"
        kubectl get svc heart-disease-lb
        echo ""
        echo "üîó API URL: http://${{ env.EXTERNAL_IP }}"
        echo ""
        echo "Test command:"
        echo "curl -X POST http://${{ env.EXTERNAL_IP }}/predict -H 'Content-Type: application/json' -d '{\"age\":55,\"sex\":1,\"cp\":0,\"trestbps\":130,\"chol\":256,\"fbs\":0,\"restecg\":1,\"thalach\":142,\"exang\":1,\"oldpeak\":0.6,\"slope\":1,\"ca\":1,\"thal\":6}'"
